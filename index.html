<!DOCTYPE HTML>
<html>
<head>
    <title>Spark Video Website</title>

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Our Spark video project">
    <meta name="author" content="Phil, Tony, Joan, Carlos">

    <link href="bootstrap/css/bootstrap.css" rel="stylesheet">
    <link href="bootstrap/css/bootstrap-responsive.css" rel="stylesheet">

    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script src="http://www.parsecdn.com/js/parse-1.2.2.min.js"></script>
    <script src="bootstrap/js/bootstrap.min.js"></script>
    <script src="underscore/underscore-min.js"></script>
    <script src="knockout/knockout-2.2.1.js"></script>

    <script type="text/javascript">
        function ViewModel() {
            var self = this;

            self.PageNumber = ko.observable(0);
            self.Videos = ko.observableArray([]);

            self.ErrorMessage = ko.observable();

            self.ShowErrorMessage = function(error) {
                self.ErrorMessage(error);
                $('#errorModal').modal();
            };

            self.LoggedIn = ko.observable(false);
            self.Username = ko.observable('');
            self.Password = ko.observable('');

            self.SearchText = ko.observable('');

            self.Tags = ko.observableArray([]);
			
			self.SuggestionsPageNumber = ko.observable(0);
			self.Suggestions = ko.observableArray([]);
			
			self.LoadSuggestions = function () {
				var suggestion = Parse.Object.extend("Suggestion");
				var query = new Parse.Query(suggestion);
				query.skip(20 * self.SuggestionsPageNumber());
				query.limit(20);
				query.find({
					success: function(results) {
						self.Suggestions(_.map(results, function(suggestion) {
							var videoObject = {
								parseObject: suggestion,
								URL: suggestion.get('URL'),
								Created: suggestion.createdAt,
								Thumbnail: ''
							};
							
							self.DownloadTitleAndThumbnail(videoObject);
							
							return videoObject;
						}));
					},
					error: function(error) {
						self.ShowErrorMessage("Error: " + error.message);
					}
				});
			};
			
			self.LoadMoreSuggestionsCommand = function() {
				self.SuggestionsPageNumber(self.PageNumber() + 1);
				self.LoadSuggestions();
			};
			
			self.LoadMoreVideosCommand = function() {
				self.PageNumber(self.PageNumber() + 1);
				self.LoadVideos();
			};
			
			self.Approve = function(o) {
				var Video = Parse.Object.extend("Video");
				
				var video = new Video();

				video.set("URL", o.URL);
				
				video.save(null, {
					success: function(gameScore) {
						self.DeleteAndReloadSuggestions(o.parseObject);
					},
					error: function(gameScore, error) {
						self.ShowErrorMessage('Error: ' + error.message);
					}
				});
			};
			
			self.Reject = function(o) {
				self.DeleteAndReloadSuggestions(o.parseObject);
			};
			
			self.DeleteAndReloadSuggestions = function(parseObject) {
				parseObject.destroy({
					success: function() {
						self.LoadSuggestions();
					},
					error: function(error) {
						self.ShowErrorMessage("Error: " + error.message);
					}
				});
			};

            self.Login = function () {
                Parse.User.logIn(self.Username(), self.Password(), {
                    success: function (user) {
                        self.LoggedIn(true);
						if (user.getUsername() == 'admin'){
							self.LoadSuggestions();
						}
                    },
                    error: function (user, error) {
                        self.ShowErrorMessage("Invalid username or password. Please try again.");
                    }
                });
            };

            self.LogoutCommand = function () {
                if (Parse.User.current()) {
                    Parse.User.logOut();
                    self.LoggedIn(false);
                }
            };

            self.SearchCommand = function () {
                // todo
            };

            self.ShowTagCommand = function () {
                // todo
            };

            self.LoadVideos = function () {
                var video = Parse.Object.extend("Video");
                var query = new Parse.Query(video);
                query.skip(20 * self.PageNumber());
                query.limit(20);
                query.find({
                    success: function (results) {
                        self.Videos(_.map(results, function (video) {
                            var videoObject = {
                                URL: video.get('URL'),
                                Created: video.createdAt,
								Thumbnail: ''
                            };
							
							self.DownloadTitleAndThumbnail(videoObject);
							
							return videoObject;
                        }));
                    },
                    error: function (error) {
                        self.ShowErrorMessage("Error: " + error.message);
                    }
                });
            };
			
			self.DownloadTitleAndThumbnail = function(videoObject) {
				var url = videoObject.URL;
				var indexOfVideoID = url.indexOf('v=');
				
				videoObject.Thumbnail = '';
				
				if (indexOfVideoID > -1) {
					var videoID = url.substring(indexOfVideoID + 2, url.length);
					var dataUrl = 'https://gdata.youtube.com/feeds/api/videos/' + videoID;
					
					$.ajax({
						url: dataUrl,
						async: false
					}).done(function(xml) {
                        videoObject.Title = $(xml).children('entry').children('title').text();
						videoObject.Thumbnail = $(xml).children('entry').children('media\\:group').children('media\\:thumbnail').attr('url');
					});
				}
			};

            self.CheckCookie = function () {
                self.LoggedIn(Parse.User.current() != null);
				
				if (self.LoggedIn() && Parse.User.current().getUsername() == 'admin') {
					self.LoadSuggestions();
				}
            };

            self.LoadVideos();

            self.CheckCookie();
        }

        function RegisterViewModel(outerSelf) {
            var self = this;

            self.Username = ko.observable('');
            self.Password1 = ko.observable('');
            self.Password2 = ko.observable('');

            self.Register = function () {
                if (self.Password1() !== self.Password2()) {
                    outerSelf.ShowErrorMessage("Passwords do not match");
                } else {
                    Parse.User.signUp(self.Username(), self.Password1(), { ACL: new Parse.ACL() }, {
                        success: function (user) {
                            window.location = 'index.html';
                        },
                        error: function (user, error) {
                            outerSelf.ShowErrorMessage("Unable to create an account: " + error.message);
                        }
                    });
                }
            };
        }
		
		function SubmitViewModel(outerSelf) {
			var self = this;
			
			self.URL = ko.observable('');
			
			self.SubmitCommand = function() {
				var Suggestion = Parse.Object.extend("Suggestion");
				
				var suggestion = new Suggestion();
				
				suggestion.set("URL", self.URL());
				
				suggestion.save(null, {
					success: function(gameScore) {
						window.location = 'index.html';
					},
					error: function(gameScore, error) {
						outerSelf.ShowErrorMessage('Error: ' + error.message);
					}
				});
			};
		}

        $(function () {
            Parse.initialize("nki3cdTqmIo6t4M5mR9eu4AYUCQubb6HYqunH4tL", "dvTEUTs3wO5R4fU7IYInJzuGrlG5eF4fBIuxIsOt");

            var vm = new ViewModel();

            ko.applyBindings(vm, $('#main')[0]);
            ko.applyBindings(vm, $('#errorModal')[0]);
            ko.applyBindings(new RegisterViewModel(vm), $('#registerModal')[0]);
			ko.applyBindings(new SubmitViewModel(vm), $('#submitModal')[0]);
        });
    </script>
    <style>
      body { background: url('images/white_carbonfiber.png'); }

      h1, h2, h3 { color: #1080ff; }

      a { color: #1080ff; }

      a:hover { text-decoration: none; }

.navbar-inner
{
    padding: 15px;
    font-size: 115%;
    background: #af1111; /* Old browsers */
background: -moz-linear-gradient(top,  #af1111 1%, #660202 100%); /* FF3.6+ */
background: -webkit-gradient(linear, left top, left bottom, color-stop(1%,#af1111), color-stop(100%,#660202)); /* Chrome,Safari4+ */
background: -webkit-linear-gradient(top,  #af1111 1%,#660202 100%); /* Chrome10+,Safari5.1+ */
background: -o-linear-gradient(top,  #af1111 1%,#660202 100%); /* Opera 11.10+ */
background: -ms-linear-gradient(top,  #af1111 1%,#660202 100%); /* IE10+ */
background: linear-gradient(to bottom,  #af1111 1%,#660202 100%); /* W3C */
filter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#af1111', endColorstr='#660202',GradientType=0 ); /* IE6-9 */
border: 0;
    border-radius: 5px;
    box-shadow: #000 0 0 10px;
    color: #ffffff;
}

.navbar .brand
{
    font-size: 1.75em;
}

.navbar .brand, .navbar .nav > li > a
{
    color: #ffffff;
}
    </style>
</head>
<body>
    <div id="main">
      <div class="container" style="background: #fafafa; margin: 20px auto;padding: 20px; box-shadow: 0 0 20px #808080;">
        <div class="navbar">
            <div class="navbar-inner">
                    <a class="brand" href="#">Spark Video Project</a>
                    <ul class="nav">
                        <li><a href="index.html">Home</a></li>
						<li><a href="#submitModal" data-bind="visible: LoggedIn" role="button" data-toggle="modal">Submit Video</a></li>
                        <li><a href="#registerModal" data-bind="visible: !LoggedIn()" role="button" data-toggle="modal">Register</a></li>
						<li><a href="#" data-bind="click: LogoutCommand, visible: LoggedIn">Log Out</a></li>
                    </ul>
                    <form class="navbar-form pull-right" data-bind="visible: !LoggedIn()">
                        <input type="text" class="span2" id="username" placeholder="Username" data-bind="value: Username" />
                        <input type="password" class="span2" id="password" placeholder="Password" data-bind="value: Password" />
                        <button type="submit" class="btn" data-bind="click: Login">Login</button>
                    </form>
                </div>
            </div> 
			
			<form class="form-search pull-right">
                <div class="input-append">
                    <input type="text" placeholder="Search" data-bind="value: SearchText" class="input-medium search-query">
                    <button type="submit" data-bind="click: SearchCommand" class="btn">Go</button>
                </div>
            </form>
					
            <div class="row-fluid">
                <div class="span12">
                    <h2>Tags</h2>
					
					<p>TODO</p>

                    <ul data-bind="foreach: Tags">
                        <li><a data-bind="click: ShowTagCommand, text: Title"></a></li>
                    </ul>
					
					<!-- ko if: LoggedIn() && _.any(Suggestions()) -->
					
                    <h2>Suggested Videos</h2>
					
                    <div data-bind="foreach: Suggestions">
					  <div class="well">
                       <div class="pull-left">
					     <a data-bind="attr: { 'href': URL }" target="_blank">
						   <img data-bind="attr: { 'src': Thumbnail }" class="img-polaroid" width="140" height="140" /></a>
					   </div>
					   <div style="margin-left: 10px;" class="pull-left">
                       	 <h4><a data-bind="attr: { 'href': URL }, text: Title"></a></h4>
                       	 <div>
						   <a href="#" class="btn" data-bind="click: $root.Approve">Approve</a> 
                       	   <a href="#" class="btn" data-bind="click: $root.Reject">Reject</a>
						 </div>
                       </div>
					   <div class="clearfix"></div>
					  </div>
                    </div>
					
					<div><a href="#" class="btn btn-primary" data-bind="click: LoadMoreSuggestionsCommand">More</a></div>
					
					<!-- /ko -->
					
					<h2>Videos</h2>
					
					<p data-bind="visible: LoggedIn">Don't see a video you like? <a href="#submitModal" role="button" data-toggle="modal">Suggest it</a> now.</p>
					
					<div data-bind="foreach: Videos">
					  <div class="well" style="background: #f0f0f0; border-radius: 5px; box-shadow:0 0 10px #808080;">
                         <div class="pull-left" style="margin: 10px;">
					      <a data-bind="attr: { 'href': URL }" target="_blank"> 
						  <img data-bind="attr: { 'src': Thumbnail }" class="img-polaroid" width="140" height="140" /> </a>
					     </div>
					     <div>
                         	 <h4 style="word-wrap: normal" ><a data-bind="attr: { 'href': URL }, text: Title"></a></h4>
                         </div>
					     <div class="clearfix"></div>
					   </div>
                    </div>
					
					<div><a href="#" class="btn btn-primary" data-bind="click: LoadMoreVideosCommand">More</a></div>
                </div>
            </div>
        </div>
    </div>

    <div id="registerModal" class="modal hide fade">
        <div class="modal-header">
            <h3>Register</h3>
        </div>
        <div class="modal-body">
            <form class="form-horizontal">
                <div class="control-group">
                    <label class="control-label" for="username">Username</label>
                    <div class="controls">
                        <input type="text" placeholder="Username" data-bind="value: Username" />
                    </div>
                </div>
                <div class="control-group">
                    <label class="control-label" for="password">Password</label>
                    <div class="controls">
                        <input type="password" placeholder="Password" data-bind="value: Password1" />
                    </div>
                </div>
                <div class="control-group">
                    <label class="control-label" for="password">Confirm Password</label>
                    <div class="controls">
                        <input type="password" placeholder="Confirm Password" data-bind="value: Password2" />
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="submit" class="btn btn-primary" data-bind="click: Register">Register</button>
        </div>
    </div>

    <div id="submitModal" class="modal hide fade">
        <div class="modal-header">
            <h3>Submit Video</h3>
        </div>
        <div class="modal-body">
            <form class="form-horizontal">
              <div class="control-group">
                <label class="control-label" for="url">Link</label>
  	              <div class="controls">
  	              <input type="text" id="url" placeholder="The web address of the video" data-bind="value: URL">
  	            </div>
              </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="submit" class="btn btn-primary" data-bind="click: SubmitCommand">Submit</button>
        </div>
    </div>

    <div id="errorModal" class="modal hide fade">
        <div class="modal-header">
            <h3>Error</h3>
        </div>
        <div class="modal-body">
            <div data-bind="text: ErrorMessage"></div>
        </div>
    </div>
</body>
</html>
