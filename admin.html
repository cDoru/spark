<!DOCTYPE HTML>
<html>
<head>
    <title>Spark Video Website</title>
	
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Our Spark video project">
    <meta name="author" content="Phil, Tony, Joan, Carlos">

    <link href="bootstrap/css/bootstrap.css" rel="stylesheet">
	<link href="bootstrap/css/bootstrap-responsive.css" rel="stylesheet">
	
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script> 
	<script src="http://www.parsecdn.com/js/parse-1.2.2.min.js"></script>
	<script src="underscore/underscore-min.js"></script>
	<script src="knockout/knockout-2.2.1.js"></script>
	
	<script language="javascript">
		function ViewModel() {
			var self = this;
			
			self.PageNumber = ko.observable(0);
			self.Suggestions = ko.observableArray([]);
			
			self.LoadSuggestions = function () {
				var suggestion = Parse.Object.extend("Suggestion");
				var query = new Parse.Query(suggestion);
				query.skip(20 * self.PageNumber());
				query.limit(20);
				query.find({
					success: function(results) {
						self.Suggestions(_.map(results, function(suggestion) {
							return {
								parseObject: suggestion,
								Title: suggestion.get('Title'),
								URL: suggestion.get('URL'),
								Created: suggestion.createdAt
							};
						}));
					},
					error: function(error) {
						alert("Error: " + error.message);
					}
				});
			};
			
			self.Approve = function(o) {
				var Video = Parse.Object.extend("Video");
				
				var video = new Video();
				
				video.set("Title", o.Title);
				video.set("URL", o.URL);
				
				video.save(null, {
					success: function(gameScore) {
						self.DeleteAndReloadSuggestions(o.parseObject);
					},
					error: function(gameScore, error) {
						window.alert('Error: ' + error.message);
					}
				});
			};
			
			self.Reject = function(o) {
				self.DeleteAndReloadSuggestions(o.parseObject);
			};
			
			self.DeleteAndReloadSuggestions = function(parseObject) {
				parseObject.destroy({
					success: function() {
						self.LoadSuggestions();
					},
					error: function(error) {
						alert("Error: " + error.message);
					}
				});
			};
			
			self.LoadSuggestions();
		}
	
		$(function() {
			Parse.initialize("nki3cdTqmIo6t4M5mR9eu4AYUCQubb6HYqunH4tL", "dvTEUTs3wO5R4fU7IYInJzuGrlG5eF4fBIuxIsOt");
			
			// TODO: check roles
			
			if (!Parse.User.current()) {
				window.location = 'login.html';
			} else {
				ko.applyBindings(new ViewModel());
			}
		});
	</script>
</head>
<body>
	<div class="navbar">
      <div class="navbar-inner">
        <div class="container">
          <a class="brand" href="#">Spark Video Project</a>
            <ul class="nav">
              <li><a href="index.html">Home</a></li>
              <li><a href="submit.html">Submit Video</a></li>
              <li><a href="logout.html">Log Out</a></li>
            </ul>
        </div>
      </div>
    </div>

    <div class="container">
      <h1>Admin</h1>
	  
	  <h2>Video Suggestions</h2>
      
	  <ul data-bind="foreach: Suggestions">
		<li>
			<a data-bind="attr: { 'href': URL }, text: Title"></a> - 
			<a href="#" data-bind="click: $root.Approve">Approve</a> / 
			<a href="#" data-bind="click: $root.Reject">Reject</a>
		</li>
	  </ul>
    </div>
</body>
</html>
